<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Equity Crew 26 | Elite Hub</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;800&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        :root {
            --gold: #d4af37; --emerald: #064e3b; --deep-green: #022c22;
            --glass: rgba(2, 44, 34, 0.98); --border: rgba(212, 175, 55, 0.2); --crimson: #ef4444;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { 
            font-family: 'Poppins', sans-serif; 
            background: linear-gradient(rgba(2, 44, 34, 0.98), rgba(2, 44, 34, 0.98)), #022c22;
            color: white; min-height: 100vh; padding-bottom: 90px;
        }

        .hidden { display: none !important; }
        .container { max-width: 500px; margin: 0 auto; padding: 15px; }
        .cambria { font-family: 'Cambria', serif; }

        /* Luxury AI Deco Classes */
        .deco-gold { border: 2px solid var(--gold) !important; background: linear-gradient(45deg, #022c22, #064e3b) !important; padding: 25px !important; text-align: center; }
        .deco-emerald { border: 2px solid #10b981 !important; box-shadow: inset 0 0 20px rgba(16,185,129,0.2); }

        .elite-card {
            background: rgba(255, 255, 255, 0.04); border-radius: 20px; border: 1px solid var(--border);
            padding: 15px; margin-bottom: 15px; position: relative; overflow: hidden;
        }

        .btn-luxury {
            padding: 10px 18px; border-radius: 12px; border: none;
            background: linear-gradient(135deg, var(--gold), #b08d29);
            color: #022c22; font-weight: 800; cursor: pointer; font-size: 0.7rem; text-transform: uppercase;
        }

        .form-input {
            width: 100%; padding: 12px; margin-bottom: 10px; border-radius: 10px;
            background: rgba(0,0,0,0.3); border: 1px solid var(--border); color: white; outline: none;
        }

        .post-media { width: 100%; border-radius: 12px; margin: 10px 0; border: 1px solid var(--border); max-height: 400px; object-fit: cover; }
        .action-row { display: flex; gap: 20px; margin-top: 15px; font-size: 0.8rem; }
        .like-btn { cursor: pointer; transition: 0.3s; display: flex; align-items: center; gap: 5px; }
        .like-btn:hover { transform: scale(1.2); color: #f87171; }
        .liked { color: var(--gold) !important; }

        .bottom-nav {
            position: fixed; bottom: 0; left: 0; right: 0; background: var(--glass);
            display: flex; justify-content: space-around; padding: 12px 10px 25px;
            border-top: 1px solid var(--border); z-index: 1000;
        }
        .nav-link { color: #555; display: flex; flex-direction: column; align-items: center; gap: 4px; cursor: pointer; }
        .nav-link.active { color: var(--gold); }
        .exec-badge { background: var(--gold); color: black; font-size: 0.5rem; padding: 2px 6px; border-radius: 4px; font-weight: 800; }
    </style>
</head>
<body>

    <div id="auth-screen" class="container" style="padding-top: 50px;">
        <div class="elite-card" style="text-align:center;">
            <h1 class="cambria" style="color:var(--gold); font-size: 2.2rem;">EQUITY 26</h1>
            <div id="auth-choice">
                <button class="btn-luxury" style="width:100%; margin-top:20px;" onclick="showReg('Student')">Student Portal</button>
                <button class="btn-luxury" style="width:100%; margin-top:10px; background:transparent; color:var(--gold); border:1px solid var(--gold);" onclick="gate()">Executive Entry</button>
            </div>
            <div id="reg-form" class="hidden">
                <input type="text" id="reg-name" class="form-input" placeholder="Name">
                <input type="text" id="reg-matric" class="form-input" placeholder="Matric No">
                <div id="exec-fields" class="hidden">
                    <input type="password" id="reg-code" class="form-input" placeholder="Access Code">
                </div>
                <button class="btn-luxury" style="width:100%;" onclick="handleAuth()">Enter Hub</button>
            </div>
        </div>
    </div>

    <div id="main-app" class="hidden">
        <header style="padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border);">
            <div class="cambria" style="color:var(--gold); font-weight:800;">HUB</div>
            <img id="u-pfp" style="width:32px; height:32px; border-radius:50%; border:1px solid var(--gold);">
        </header>

        <div class="container">
            <section id="tab-feed">
                <div class="elite-card">
                    <textarea id="post-text" class="form-input" placeholder="Speak your mind..." style="height:60px; resize:none;"></textarea>
                    <div style="display:flex; justify-content: space-between; align-items: center;">
                        <div style="display:flex; gap:10px;">
                            <label style="cursor:pointer; color:var(--gold);"><i data-lucide="paperclip"></i>
                                <input type="file" id="post-file" class="hidden" accept="image/*,video/*,.txt" onchange="handleFile(this)">
                            </label>
                            <button class="btn-luxury" style="background:#064e3b; color:white; border:1px solid #10b981;" onclick="applyAiDeco()">AI Decor</button>
                        </div>
                        <button class="btn-luxury" id="post-btn" onclick="publishPost()">Post</button>
                    </div>
                    <div id="upload-progress" style="font-size:0.6rem; margin-top:5px; color:var(--gold);"></div>
                </div>
                <div id="feed-display"></div>
            </section>

            <section id="tab-chat" class="hidden">
                <h3 class="cambria" style="color:var(--gold); margin-bottom:15px;">Private Directory</h3>
                <div id="chat-list"></div>
            </section>

            <section id="tab-profile" class="hidden">
                <div class="elite-card" style="text-align:center;">
                    <img id="p-img" style="width:80px; height:80px; border-radius:50%; border:2px solid var(--gold);">
                    <h2 id="p-name" class="cambria"></h2>
                    <button class="btn-luxury" style="margin-top:20px; background:var(--crimson); color:white;" onclick="logout()">Logout</button>
                </div>
            </section>
        </div>

        <nav class="bottom-nav">
            <div class="nav-link active" onclick="switchTab('feed')"><i data-lucide="layout"></i><small>Feed</small></div>
            <div class="nav-link" onclick="switchTab('chat')"><i data-lucide="shield"></i><small>Chat</small></div>
            <div class="nav-link" onclick="switchTab('profile')"><i data-lucide="user"></i><small>Profile</small></div>
        </nav>
    </div>

    <div id="chat-drawer" class="hidden" style="position:fixed; inset:0; background:#021a14; z-index:2000; display:flex; flex-direction:column;">
        <div style="padding:20px; border-bottom:1px solid var(--border); display:flex; justify-content:space-between;">
            <b id="chat-target" class="cambria" style="color:var(--gold);"></b>
            <i data-lucide="x" onclick="closeChat()"></i>
        </div>
        <div id="chat-msgs" style="flex:1; overflow-y:auto; padding:20px; display:flex; flex-direction:column;"></div>
        <div style="padding:20px; display:flex; gap:10px;">
            <input type="text" id="msg-input" class="form-input" style="margin:0;" placeholder="Message...">
            <button class="btn-luxury" onclick="sendMsg()"><i data-lucide="send"></i></button>
        </div>
    </div>

    <script>
        const firebaseConfig = { 
            apiKey: "AIzaSyC7ui6tasM3GgtetrLiqSO3qMbuzOvcdMU", 
            authDomain: "dgmarketplace-6ae42.firebaseapp.com", 
            projectId: "dgmarketplace-6ae42", 
            storageBucket: "dgmarketplace-6ae42.appspot.com", 
            messagingSenderId: "650691092405", 
            appId: "1:650691092405:web:e174e43bf5b93d7f13c3fc" 
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const storage = firebase.storage();

        let user = JSON.parse(localStorage.getItem('ec26_user'));
        let isExec = false;
        let fileData = { url: "", type: "" };
        let activeChat = null;
        let isAiDeco = false;

        window.onload = () => { if(user) showApp(); lucide.createIcons(); };

        function gate() { if(prompt("Passcode:") === "1234") { isExec = true; showReg('Executive'); } }
        function showReg(t) {
            document.getElementById('auth-choice').classList.add('hidden');
            document.getElementById('reg-form').classList.remove('hidden');
            if(isExec) document.getElementById('exec-fields').classList.remove('hidden');
        }

        async function handleAuth() {
            const n = document.getElementById('reg-name').value;
            const m = document.getElementById('reg-matric').value;
            if(!n) return;
            user = { id: "U"+Date.now(), name: n, matric: m, isExec, pic: `https://api.dicebear.com/7.x/avataaars/svg?seed=${n}`, role: isExec ? "Executive" : "Student" };
            localStorage.setItem('ec26_user', JSON.stringify(user));
            await db.collection("users").doc(user.id).set(user);
            showApp();
        }

        function showApp() {
            document.getElementById('auth-screen').classList.add('hidden');
            document.getElementById('main-app').classList.remove('hidden');
            document.getElementById('u-pfp').src = user.pic;
            document.getElementById('p-img').src = user.pic;
            document.getElementById('p-name').innerText = user.name;
            renderFeed(); renderChats();
        }

        async function handleFile(input) {
            const file = input.files[0];
            if(!file) return;
            if(file.size > 15 * 1024 * 1024) return alert("File too large (Max 15MB)");

            document.getElementById('upload-progress').innerText = "Uploading Media...";
            const ref = storage.ref(`media/${Date.now()}_${file.name}`);
            const task = ref.put(file);
            
            task.on('state_changed', (snap) => {
                let p = (snap.bytesTransferred / snap.totalBytes) * 100;
                document.getElementById('upload-progress').innerText = `Uploading: ${Math.round(p)}%`;
            }, null, async () => {
                fileData.url = await ref.getDownloadURL();
                fileData.type = file.type;
                document.getElementById('upload-progress').innerText = "Media Ready.";
            });
        }

        function applyAiDeco() {
            isAiDeco = true;
            document.getElementById('upload-progress').innerText = "AI Decoration Applied âœ¨";
        }

        async function publishPost() {
            const txt = document.getElementById('post-text').value;
            if(!txt && !fileData.url) return;

            await db.collection("posts").add({
                uid: user.id, name: user.name, role: user.role, pic: user.pic,
                txt, file: fileData.url, fileType: fileData.type, deco: isAiDeco,
                likes: [], comments: [], time: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            document.getElementById('post-text').value = "";
            fileData = { url: "", type: "" };
            isAiDeco = false;
            document.getElementById('upload-progress').innerText = "";
        }

        function renderFeed() {
            db.collection("posts").orderBy("time", "desc").onSnapshot(snap => {
                const f = document.getElementById('feed-display'); f.innerHTML = "";
                snap.forEach(doc => {
                    const d = doc.data(); const pid = doc.id;
                    const isVid = d.fileType && d.fileType.includes("video");
                    const isTxtFile = d.fileType && d.fileType.includes("text");
                    
                    f.innerHTML += `
                        <div class="elite-card ${d.deco ? 'deco-gold' : ''}">
                            <div style="display:flex; justify-content:space-between; align-items:center;">
                                <div style="display:flex; align-items:center; gap:8px;">
                                    <img src="${d.pic}" style="width:30px; border-radius:50%;">
                                    <b style="font-size:0.7rem;">${d.name}</b>
                                </div>
                                ${d.uid === user.id ? `<i data-lucide="trash-2" onclick="delPost('${pid}')" style="width:14px; color:var(--crimson);"></i>` : `<i data-lucide="flag" style="width:14px; opacity:0.3;"></i>`}
                            </div>
                            <p style="margin-top:10px; font-size:0.85rem;">${d.txt}</p>
                            ${d.file ? (isVid ? `<video src="${d.file}" controls class="post-media"></video>` : (isTxtFile ? `<div class="elite-card" style="background:black; font-size:0.7rem;">ðŸ“„ Text Document Attached</div>` : `<img src="${d.file}" class="post-media">`)) : ''}
                            <div class="action-row">
                                <div class="like-btn" onclick="like('${pid}')"><i data-lucide="heart"></i> ${d.likes.length}</div>
                                <div onclick="alert('Comments coming soon')"><i data-lucide="message-circle"></i> ${d.comments.length}</div>
                            </div>
                        </div>`;
                });
                lucide.createIcons();
            });
        }

        async function like(pid) {
            const ref = db.collection("posts").doc(pid); const d = await ref.get();
            let l = d.data().likes || [];
            l.includes(user.id) ? l = l.filter(i => i !== user.id) : l.push(user.id);
            await ref.update({ likes: l });
        }

        async function delPost(pid) { if(confirm("Delete post?")) await db.collection("posts").doc(pid).delete(); }

        // CHAT LOGIC
        function renderChats() {
            const list = document.getElementById('chat-list'); list.innerHTML = "";
            if(!user.isExec) {
                // Students see all Executives
                db.collection("users").where("isExec", "==", true).onSnapshot(snap => {
                    list.innerHTML = "";
                    snap.forEach(doc => {
                        const u = doc.data();
                        list.innerHTML += `<div class="elite-card" onclick="openChat('${u.id}', '${u.name}')" style="cursor:pointer;"><b>${u.name}</b><br><small>${u.role}</small></div>`;
                    });
                });
            } else {
                // Executives see students who are in their "chats" collection
                db.collection("users").where("isExec", "==", false).onSnapshot(snap => {
                    list.innerHTML = "";
                    snap.forEach(doc => {
                        const u = doc.data();
                        list.innerHTML += `<div class="elite-card" onclick="openChat('${u.id}', '${u.name}')" style="cursor:pointer;"><b>${u.name}</b><br><small>Student</small></div>`;
                    });
                });
            }
        }

        function openChat(id, name) {
            activeChat = id; document.getElementById('chat-target').innerText = name;
            document.getElementById('chat-drawer').classList.remove('hidden');
            const rid = [user.id, id].sort().join('_');
            db.collection("chats").doc(rid).collection("m").orderBy("time", "asc").onSnapshot(snap => {
                const b = document.getElementById('chat-msgs'); b.innerHTML = "";
                snap.forEach(m => {
                    const d = m.data();
                    b.innerHTML += `<div class="chat-bubble ${d.sid === user.id ? 'sent' : 'received'}">${d.t}</div>`;
                });
                b.scrollTop = b.scrollHeight;
            });
        }

        async function sendMsg() {
            const t = document.getElementById('msg-input').value; if(!t) return;
            const rid = [user.id, activeChat].sort().join('_');
            await db.collection("chats").doc(rid).collection("m").add({ sid: user.id, t, time: firebase.firestore.FieldValue.serverTimestamp() });
            document.getElementById('msg-input').value = "";
        }

        function switchTab(t) {
            document.querySelectorAll('section').forEach(s => s.classList.add('hidden'));
            document.querySelectorAll('.nav-link').forEach(n => n.classList.remove('active'));
            document.getElementById('tab-'+t).classList.remove('hidden');
            event.currentTarget.classList.add('active');
            lucide.createIcons();
        }
        function closeChat() { document.getElementById('chat-drawer').classList.add('hidden'); }
        function logout() { localStorage.clear(); location.reload(); }
    </script>
</body>
</html>