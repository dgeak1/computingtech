<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Equity Elite | Hub</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;800&family=Orbitron:wght@700&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        @import url("https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;800&display=swap");

        :root {
            --primary-gold: #D4AF37;
            --gold: #D4AF37;
            --deep-emerald: #011a14;
            --accent-green: #059669;
            --glass-bg: rgba(255, 255, 255, 0.03);
            --glass-border: rgba(212, 175, 55, 0.15);
            --border: rgba(212, 175, 55, 0.15);
            --text-main: #f8fafc;
            --text-dim: #94a3b8;
            --card-radius: 24px;
        }

        * {  margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: 'Poppins', sans-serif; }

        body { 
            background: rgb(31, 23, 0); 
            color: var(--text-main); 
            min-height: 100vh;
            background-image: radial-gradient(circle at top right, #000000, transparent),
                              radial-gradient(circle at bottom left, #2e0202, transparent);
            overflow-x: hidden; padding-bottom: 100px;
        }

        .hidden { display: none !important; }
        .app-container { max-width: 480px; margin: 0 auto; min-height: 100vh; position: relative; padding: 20px; }
        .heading-font { font-family: 'Orbitron', sans-serif; letter-spacing: 2px; }

        .post-box-container {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 24px; padding: 20px; margin-bottom: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .post-textarea {
            width: 100%; background: rgba(0, 0, 0, 0.2); border: 1px solid var(--glass-border);
            border-radius: 15px; padding: 15px; color: white; font-size: 0.9rem;
            resize: none; outline: none; margin-bottom: 15px;
        }

        .post-actions { display: flex; justify-content: space-between; align-items: center; }

        .media-button {
            display: flex; align-items: center; gap: 8px; color: var(--gold);
            font-size: 0.75rem; font-weight: 600; padding: 8px 12px;
            border-radius: 10px; background: rgba(130, 108, 36, 0.1);
        }

        .glass-card {
            background: var(--glass-bg); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border); border-radius: var(--card-radius);
            padding: 20px; margin-bottom: 20px;
        }

        #market-display {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
}

/* Make market cards feel high-tech */
#market-display .glass-card {
    border-left: 3px solid var(--primary-gold);
    transition: transform 0.3s ease;
}

#market-display .glass-card:hover {
    transform: translateY(-5px);
}

        .btn-gold {
            background: linear-gradient(135deg, #D4AF37 0%, #B08D29 100%);
            color: #011a14; padding: 16px; border-radius: 16px; border: none;
            font-weight: 800; font-size: 0.8rem; text-transform: uppercase; width: 100%;
        }

        .bottom-nav {
            position: fixed; bottom: 0; left: 0; right: 0; background: rgba(1, 26, 20, 0.95);
            border-top: 1px solid var(--glass-border); display: flex; justify-content: space-around;
            padding: 15px 10px 30px; z-index: 1000;
        }

        .nav-item { display: flex; flex-direction: column; align-items: center; color: var(--text-dim); gap: 4px; }
        .nav-item.active { color: var(--primary-gold); }

        .chat-container { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 12px; }
        .bubble { max-width: 80%; padding: 12px 16px; border-radius: 20px; font-size: 0.85rem; line-height: 1.5; }
        .bubble.sent { align-self: flex-end; background: var(--primary-gold); color: #011a14; border-bottom-right-radius: 4px; }
        .bubble.received { align-self: flex-start; background: var(--glass-bg); border: 1px solid var(--glass-border); border-bottom-left-radius: 4px; }

        .glass-input { width: 100%; background: rgba(0,0,0,0.3); border: 1px solid var(--glass-border); border-radius: 12px; padding: 14px; color: white; outline: none; margin-bottom: 12px; }

        .progress-circle { width: 100%; height: 8px; background: rgba(255,255,255,0.05); border-radius: 10px; margin: 20px 0; overflow: hidden; }
        .progress-fill { height: 100%; background: var(--primary-gold); width: 0%; transition: width 1s ease-in-out; }

        .id-card-view {
            height: 220px; border-radius: 24px; background: linear-gradient(135deg, #064e3b 0%, #011a14 100%);
            border: 1px solid var(--primary-gold); padding: 25px; position: relative; overflow: hidden;
        }
        /* Custom Scrollbar for Comments */
#tab-feed div div::-webkit-scrollbar {
    width: 3px;
}
.bubble {
    padding: 10px 14px;
    border-radius: 18px;
    font-size: 0.85rem;
    max-width: 80%;
    line-height: 1.4;
}
.bubble.sent {
    background: var(--primary-gold);
    color: #011a14;
    border-bottom-right-radius: 4px;
}
.bubble.received {
    background: rgba(255, 255, 255, 0.08);
    color: white;
    border-bottom-left-radius: 4px;
    border: 1px solid var(--glass-border);
}

.id-card-view {
    height: 200px;
    border-radius: 24px;
    background: linear-gradient(145deg, #022c22 0%, #011a14 100%);
    border: 1px solid rgba(212, 175, 55, 0.3);
    padding: 25px;
    position: relative;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    justify-content: center;
    box-shadow: 0 15px 35px rgba(0,0,0,0.4);
}

#p-card-img {
    box-shadow: 0 0 15px rgba(212, 175, 55, 0.3);
    transition: transform 0.5s ease;
}

.id-card-view:active #p-card-img {
    transform: scale(1.05);
}

@keyframes typingDots {
    0% { opacity: 0.3; }
    50% { opacity: 1; }
    100% { opacity: 0.3; }
}

#chat-list-container [id^="typing-"] {
    animation: typingDots 1.5s infinite;
    font-weight: 800;
    letter-spacing: 1px;
}

/* Instant scroll behavior */
.chat-container {
    scroll-behavior: smooth;
}

@keyframes pulse-ai {
    0% { transform: scale(1); opacity: 1; }
    50% { transform: scale(1.2); opacity: 0.5; }
    100% { transform: scale(1); opacity: 1; }
}

.ai-node {
    animation: pulse-ai 3s infinite ease-in-out;
}
#tab-feed div div::-webkit-scrollbar-thumb {
    background: var(--glass-border);
    border-radius: 10px;
}

.comment-item {
    padding: 4px 0;
    transition: background 0.2s;
}
.comment-item:active {
    background: rgba(239, 68, 68, 0.1); /* Flash red on hold */
}
/* AI Neural Node Decoration */
.ai-node {
    width: 8px; height: 8px; border-radius: 50%;
    background: var(--primary-gold);
    box-shadow: 0 0 10px var(--primary-gold);
    animation: ai-pulse 2s infinite ease-in-out;
}

@keyframes ai-pulse {
    0% { transform: scale(1); opacity: 1; }
    50% { transform: scale(1.3); opacity: 0.6; }
    100% { transform: scale(1); opacity: 1; }
}

/* Comment Item Styling */
.comment-item { padding: 4px; border-radius: 4px; transition: 0.2s; }
.comment-item:active { background: rgba(239, 68, 68, 0.2); }

.bubble {
    position: relative;
    max-width: 75% !important;
    word-wrap: break-word;
}

.bubble.sent {
    background: linear-gradient(135deg, var(--primary-gold), #b08d29) !important;
    color: #011a14 !important;
    font-weight: 500;
}

/* Ensure icons in chat scale properly */
[data-lucide] {
    stroke-width: 3px;
}
    </style>
</head>
<body>
    
<section></section>
<div class="app-container">
    <section id="auth-screen" style="padding-top: 80px;">
    <div class="glass-card" style="text-align: center;">
        <h1 class="heading-font" style="color: var(--primary-gold); font-size: 1.6rem;"> STUDENT HUB </h1>
        <p style="font-size: 0.6rem; opacity: 0.5; margin-top: 5px; letter-spacing: 4px;">CLASS OF 2026</p>
        
        <div id="auth-ui" style="margin-top: 40px;">
            <button class="btn-gold" onclick="showForm()">Sync Identity</button>
            <button class="btn-gold" style="background: transparent; border: 1px solid var(--primary-gold); color: var(--primary-gold); margin-top: 15px;" onclick="gate()">Executive Access</button>
        </div>

        <div id="reg-form" class="hidden" style="margin-top: 30px;">
            <input type="text" id="reg-name" class="glass-input" placeholder="Username">
            <input type="email" id="reg-email" class="glass-input" placeholder="Gmail Address">
            <input type="text" id="reg-matric" class="glass-input" placeholder="Matric Number (2026/...)">
            <button class="btn-gold" onclick="handleAuth()">Access Hub</button>
            <p onclick="location.reload()" style="font-size: 0.6rem; margin-top: 15px; opacity: 0.5; cursor: pointer;">‚Üê Back</p>
        </div>
    </div>
</section>
        

    <main id="main-app" class="hidden">
        <header style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
            <div>
                <h2 class="heading-font" style="font-size: 0.8rem; color: var(--primary-gold);"> STUDENT CHAT AND SELL HUB</h2>
                <small id="welcome-name" style="opacity: 0.6;">Welcome, Champ </small>
            </div>
            <img id="u-pfp-top" src="" style="width: 40px; height: 40px; border-radius: 12px; border: 1.5px solid var(--primary-gold);">
        </header>

        <section id="tab-feed">
            <div class="post-box-container">
                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
                    <img id="u-pfp-small" src="" style="width: 35px; height: 35px; border-radius: 50%; border: 1.5px solid var(--gold);">
                    <span style="font-size: 0.8rem; font-weight: 600; opacity: 0.8;">What's on your mind?</span>
                </div>
                <textarea id="post-text" class="post-textarea" placeholder="What's going on today?..." rows="3"></textarea>
                <div class="post-actions">
                    <label class="media-button" style="cursor: pointer;">
                        <i data-lucide="image" size="18"></i>
                        <span id="upload-status-text">Add Photo</span>
<input type="file" id="post-file" class="hidden" accept="image/*,video/*" onchange="handleFile(this)">                    </label>
                    <button class="btn-gold" style="width: auto; padding: 10px 30px; border-radius: 30px;" onclick="publishPost()">Post</button>
                </div>
            </div>
            <div id="feed-display"></div>
        </section>

        <section id="tab-market" class="hidden">
            <div class="glass-card" style="display: flex; justify-content: space-between; padding: 15px;">
                <div style="text-align: center;">
                    <small style="opacity: 0.5; font-size: 0.5rem;">LISTED VALUE</small>
                    <p id="m-stats-val" style="color: var(--primary-gold); font-weight: 800; font-size: 0.9rem;">‚Ç¶0.00</p>
                </div>
                <div style="text-align: center;">
                    <small style="opacity: 0.5; font-size: 0.5rem;">ACTIVE ITEMS</small>
                    <p id="m-stats-count" style="font-weight: 800; font-size: 0.9rem;">0</p>
                </div>
            </div>
            <input type="text" id="market-search" class="glass-input" placeholder="Search textbooks, gadgets..." onkeyup="renderMarket()">
            <div class="glass-card" style="border-style: dashed; border-color: var(--primary-gold);">
    <h4 class="heading-font" style="font-size: 0.7rem; color: var(--primary-gold); margin-bottom: 15px;">LIST NEW ITEM</h4>
    <input type="text" id="m-item-name" class="glass-input" placeholder="What are you selling?">
    <input type="number" id="m-item-price" class="glass-input" placeholder="Price (‚Ç¶)">
    
    <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 15px;">
        <label class="media-button" style="flex: 1; cursor: pointer; justify-content: center;">
            <i data-lucide="camera" size="16"></i>
            <span id="m-upload-status">Add Photo</span>
            <input type="file" id="m-item-file" class="hidden" accept="image/*" onchange="handleMarketFile(this)">
        </label>
        <button class="btn-gold" style="flex: 1; padding: 10px;" onclick="listMarketItem()">List Item</button>
    </div>
</div>

<div id="market-display"></div>
            <div id="market-display"></div>
        </section>

       <section id="tab-gp" class="hidden">
    <div class="glass-card" style="text-align: center; border-bottom: 3px solid var(--primary-gold);">
        <h4 class="heading-font" style="font-size: 0.6rem; color: var(--primary-gold); margin-bottom: 10px;">WEIGHTED GPA</h4>
        <h1 id="cgpa-display" style="font-size: 3.5rem; font-weight: 800; text-shadow: 0 0 20px rgba(212, 175, 55, 0.3);">0.00</h1>
        <div class="progress-circle"><div id="gp-progress" class="progress-fill"></div></div>
        <div style="display: flex; justify-content: space-between; margin-top: 10px; font-size: 0.75rem; font-weight: 600;">
            <span id="gp-class" style="color: var(--primary-gold);">Class: ---</span>
            <span id="total-units" style="opacity: 0.7;">Units: 0</span>
        </div>
    </div>

    <div id="course-container" style="margin-top: 20px;"></div>

    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 20px;">
        <button class="btn-gold" style="background: rgba(212, 175, 55, 0.1); color: var(--primary-gold); border: 1px solid var(--primary-gold);" onclick="addCourse()">+ Add Course</button>
        <button class="btn-gold" onclick="calculateGP()">Sync Standings</button>
    </div>
</section>

        <section id="tab-chat" class="hidden">
            <div class="glass-card" style="padding: 10px;">
                <input type="text" id="member-search" class="glass-input" style="margin:0;" placeholder="Search members..." onkeyup="filterMembers()">
            </div>
            <div id="chat-list-container"></div>
        </section>

        <section id="tab-profile" class="hidden">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
        <h2 class="heading-font" style="font-size: 0.8rem; color: var(--primary-gold);">DIGITAL IDENTITY</h2>
        <div style="display: flex; gap: 15px;">
            <i data-lucide="settings" size="20" style="opacity: 0.6; cursor: pointer;"></i>
            <i data-lucide="bell" size="20" style="opacity: 0.6; cursor: pointer;"></i>
        </div>
    </div>

    <div class="id-card-view" id="digital-id-card">
        <div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0.1; pointer-events: none; background-image: radial-gradient(circle at 2px 2px, var(--primary-gold) 1px, transparent 0); background-size: 20px 20px;"></div>
        
        <div style="display: flex; gap: 20px; align-items: center; position: relative; z-index: 1;">
            <div style="position: relative;">
                <img id="p-card-img" src="" style="width: 85px; height: 85px; border-radius: 20px; border: 2px solid var(--primary-gold); object-fit: cover; background: #000;">
                <div id="role-badge" style="position: absolute; -bottom: 10px; left: 50%; transform: translateX(-50%); background: var(--primary-gold); color: #011a14; padding: 2px 10px; border-radius: 20px; font-size: 0.5rem; font-weight: 800; white-space: nowrap; letter-spacing: 1px;">MEMBER</div>
            </div>
            
            <div style="flex: 1;">
                <h3 id="p-card-name" class="heading-font" style="font-size: 0.9rem; margin-bottom: 5px; color: white;">---- ----</h3>
                <p id="p-card-uid" style="font-family: monospace; font-size: 0.65rem; color: var(--primary-gold); opacity: 0.8;">MATRIC LOADING...</p>
                
                <div style="margin-top: 10px; display: flex; align-items: center; gap: 8px;">
                    <div style="background: rgba(255,255,255,0.1); padding: 4px 8px; border-radius: 8px;">
                        <small style="display: block; font-size: 0.45rem; opacity: 0.6;">CURRENT GP</small>
                        <b id="p-card-gp" style="font-size: 0.8rem; color: var(--primary-gold);">0.00</b>
                    </div>
                    <div style="background: rgba(255,255,255,0.1); padding: 4px 8px; border-radius: 8px;">
                        <small style="display: block; font-size: 0.45rem; opacity: 0.6;">STANDING</small>
                        <b id="p-card-standing" style="font-size: 0.6rem; white-space: nowrap;">Loading...</b>
                    </div>
                </div>
            </div>
        </div>

        <div style="position: absolute; bottom: 20px; right: 20px; opacity: 0.3;">
            <i data-lucide="fingerprint" size="40" style="color: var(--primary-gold);"></i>
        </div>
        
        <div style="position: absolute; bottom: 20px; left: 20px;">
            <small style="font-size: 0.4rem; letter-spacing: 2px; opacity: 0.5;">EQUITY ELITE HUB v2.0</small>
        </div>
    </div>

    <div style="margin-top: 30px; display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
        <div class="glass-card" style="padding: 15px; text-align: center; margin: 0;">
            <i data-lucide="edit-3" size="20" style="color: var(--primary-gold); margin-bottom: 8px;"></i>
            
            <div class="glass-card" onclick="openEditModal()"> <i data-lucide="edit-3" style="width: 14px; margin-right: 8px;"></i> EDIT PROFILE</div>
        </div>
        <div class="glass-card" style="padding: 15px; text-align: center; margin: 0;" onclick="logout()">
            <i data-lucide="log-out" size="20" style="color: #ef4444; margin-bottom: 8px;"></i>
            <p style="font-size: 0.7rem;">Sign Out</p>
        </div>
    </div>
</section>
    </main>

    <nav class="bottom-nav">
        <div class="nav-item active" onclick="switchTab('feed')"><i data-lucide="home"></i><small>Feed</small></div>
        <div class="nav-item" onclick="switchTab('market')"><i data-lucide="shopping-bag"></i><small>Market</small></div>
        <div class="nav-item" onclick="switchTab('gp')"><i data-lucide="calculator"></i><small>GP</small></div>
        <div class="nav-item" onclick="switchTab('chat')"><i data-lucide="message-square"></i><small>Chat</small></div>
        <div class="nav-item" onclick="switchTab('profile')"><i data-lucide="user"></i><small>Profile</small></div>
    </nav>

    <div id="chat-overlay" class="hidden" style="position: fixed; inset: 0; background: var(--deep-emerald); z-index: 2000; display: flex; flex-direction: column;">
        <header style="padding: 20px; border-bottom: 1px solid var(--glass-border); display: flex; align-items: center; gap: 15px;">
            <i data-lucide="chevron-left" onclick="closeChat()"></i>
            <b id="chat-header-name" style="color: var(--primary-gold);">---</b>
        </header>
        <div class="chat-container" id="chat-msgs"></div>
        <div style="padding: 20px; display: flex; gap: 10px; background: rgba(0,0,0,0.3);">
            <input type="text" id="chat-input" class="glass-input" style="margin:0;" placeholder="Message..." onkeypress="if(event.key==='Enter') sendMsg()">
            <button class="btn-gold" style="width: auto; padding: 12px 20px;" onclick="sendMsg()"><i data-lucide="send"></i></button>
        </div>
    </div>
</div>

<div id="edit-profile-overlay" class="hidden" style="position: fixed; inset: 0; background: rgba(1, 26, 20, 0.98); z-index: 3000; padding: 25px; display: flex; flex-direction: column; backdrop-filter: blur(20px);">
    <header style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
        <div>
            <h2 class="heading-font" style="font-size: 0.9rem; color: var(--primary-gold);">IDENTITY CONFIG</h2>
            <p style="font-size: 0.5rem; opacity: 0.5;">Update your digital presence</p>
        </div>
        <button onclick="closeEditModal()" style="background: none; border: none; color: white;">
            <i data-lucide="x" size="24"></i>
        </button>
    </header>

    <div style="flex: 1; overflow-y: auto; padding-right: 5px;">
        <div style="display: flex; flex-direction: column; align-items: center; margin-bottom: 25px;">
            <img id="edit-preview-img" src="" style="width: 100px; height: 100px; border-radius: 25px; border: 2px solid var(--primary-gold); object-fit: cover; margin-bottom: 10px;">
            <label class="media-button" style="cursor: pointer;">
                <i data-lucide="camera" size="14"></i>
                <span>Change Photo</span>
                <input type="file" id="edit-file-input" class="hidden" accept="image/*" onchange="handleProfilePicChange(this)">
            </label>
        </div>

        <label style="font-size: 0.6rem; color: var(--primary-gold); margin-bottom: 8px; display: block;">FULL NAME</label>
        <input type="text" id="edit-username" class="glass-input" placeholder="Display name">

        <label style="font-size: 0.6rem; color: var(--primary-gold); margin-bottom: 8px; display: block; margin-top: 20px;">BIO / TAGLINE</label>
        <textarea id="edit-bio" class="glass-input" rows="3" placeholder="Elite Member since 2026..."></textarea>

        <label style="font-size: 0.6rem; color: var(--primary-gold); margin-bottom: 8px; display: block; margin-top: 20px;">NEW ACCESS PIN (OPTIONAL)</label>
        <input type="password" id="edit-pass" class="glass-input" placeholder="Update digital key">
    </div>

    <button class="btn-gold" onclick="saveProfileChanges()" style="margin-top: 20px;">Save & Re-Sync</button>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyBLrdBzHOhsJW4_ixghTx96XpHT4QMS8s8",
        authDomain: "executo-4ecd7.firebaseapp.com",
        projectId: "executo-4ecd7",
        storageBucket: "executo-4ecd7.firebasestorage.app",
        messagingSenderId: "738758706005",
        appId: "1:738758706005:web:383f547ce4ddb8b243e5dc"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    let user = JSON.parse(localStorage.getItem('ec26_user'));
    let activeChatId = null;
    let chatSub = null;
    let postImageBase64 = "";

    // FULL 11 MEMBER EXECUTIVE PANEL
    // To change a password, just edit the "key" value.
    const EXECS = [
       { name: "Ajiferuke Ridwanullahi", role: "President", key: "PREZ26-AJ" },
    { name: "Olaniyan Kehinde", role: "Vice President", key: "VP26-AR" },
    { name: "Obidare Ibrahim", role: "Gen. Secretary", key: "SEC26-IB" },
    { name: "Salaudeen Oyindamola Muslimah", role: "Asst. Gen Sec", key: "AGS26-E10" },
    { name: "Oyebode Blessing", role: "Fin. Secretary", key: "FIN26-BL" },
    { name: "Oladimeji Obaloluwa Damilola", role: "Treasurer", key: "TRE26-EX5" },
    { name: "Yusuf Mubarak Ayinde", role: "PRO", key: "PRO26-EX6" },
    { name: "Adesoji Ayobami Zaccheaus", role: "Social Director", key: "SOC26-EX7" },
    { name: "Adeyemi AbdulAzeez", role: "Welfare Director", key: "WEL26-EX8" },
    { name: "Adewolu Adesola Adetunji", role: "Sport Director", key: "SPT26-EX9" }
        
    ];

    window.onload = () => {
        if(user) showMainApp();
        lucide.createIcons();
    };

    function gate() {
        const key = prompt("Executive Portal Key:");
        const found = EXECS.find(e => e.key === key);
        if(found) {
            document.getElementById('reg-name').value = found.name;
            document.getElementById('reg-matric').value = "EXEC-" + found.key.split('-')[1];
            showForm();
        } else alert("Denied");
    }

    function showForm() {
        document.getElementById('auth-ui').classList.add('hidden');
        document.getElementById('reg-form').classList.remove('hidden');
    }

    
    function showMainApp() {
        document.getElementById('auth-screen').classList.add('hidden');
        document.getElementById('main-app').classList.remove('hidden');
        document.getElementById('u-pfp-top').src = user.pic;
        document.getElementById('u-pfp-small').src = user.pic;
        document.getElementById('welcome-name').innerText = `Welcome, ${user.name.split(' ')[0]}`;
        renderFeed();
        renderMarket();
        renderChatList();
        addCourse();
        updateProfileUI();
    }

    function switchTab(tab) {
        document.querySelectorAll('section').forEach(s => s.classList.add('hidden'));
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        document.getElementById('tab-' + tab).classList.remove('hidden');
        event.currentTarget.classList.add('active');
        if(tab === 'profile') updateProfileUI();
        lucide.createIcons();
    }

    
async function handleAuth() {
        const name = document.getElementById('reg-name').value.trim();
        const email = document.getElementById('reg-email').value.trim().toLowerCase();
        const matric = document.getElementById('reg-matric').value.trim().toUpperCase();
        
        if(!name || !email || !matric) {
            alert("All fields required for sync.");
            return;
        }

        if(!email.includes('@gmail.com')) {
            alert("Please use a valid Gmail address.");
            return;
        }

        // Use email as the Unique ID (cleaning dots for firestore safety)
        const userId = email.replace(/[^a-zA-Z0-9]/g, '_');

        // Check if user already exists
        const userDoc = await db.collection("users").doc(userId).get();
        let userData;

        if(userDoc.exists) {
            userData = userDoc.data();
            // Update name/matric if they changed, but keep the record
            userData.name = name;
            userData.matric = matric;
        } else {
            userData = {
                id: userId,
                email: email,
                name: name,
                matric: matric,
                role: (matric.startsWith('EXEC') || name.includes('Obidare')) ? "Executive" : "Student",
                pic: `https://api.dicebear.com/7.x/avataaars/svg?seed=${name}`,
                bio: "Elite Member since 2026",
                cgpa: "0.00",
                standing: "N/A"
            };
        }

        try {
            await db.collection("users").doc(userId).set(userData, {merge: true});
            localStorage.setItem('ec26_user', JSON.stringify(userData));
            user = userData;
            showMainApp();
        } catch(e) { 
            alert("Auth Error: " + e.message); 
        }
    }

    // --- ENHANCED PROFILE LOGIC ---

    function updateProfileUI() {
        if (!user) return;

        // Card Image & Name
        document.getElementById('u-pfp-top').src = user.pic;
        document.getElementById('p-card-img').src = user.pic;
        document.getElementById('p-card-name').innerText = user.name;
        
        // Dynamic Bio & Matric display
        const bioText = user.bio || "Elite Member";
        document.getElementById('p-card-uid').innerHTML = `
            ${user.matric} <br> 
            <span style="font-size: 0.55rem; color: white; opacity: 0.5; font-family: 'Poppins'; font-style: italic;">
                "${bioText}"
            </span>`;
        
        // Stats
        document.getElementById('p-card-gp').innerText = user.cgpa || "0.00";
        document.getElementById('p-card-standing').innerText = user.standing || "N/A";

        // Role Handling
        const roleBadge = document.getElementById('role-badge');
        if (user.role === "Executive") {
            roleBadge.innerText = "EXECUTIVE";
            roleBadge.style.background = "var(--primary-gold)";
            document.getElementById('digital-id-card').style.boxShadow = "0 0 25px rgba(212, 175, 55, 0.2)";
        } else {
            roleBadge.innerText = "MEMBER";
            roleBadge.style.background = "rgba(255,255,255,0.2)";
        }
        lucide.createIcons();
    }

    async function saveProfileChanges() {
        const newName = document.getElementById('edit-username').value.trim();
        const newBio = document.getElementById('edit-bio').value.trim();
        
        if (!newName) return alert("Name is required.");

        const updateData = {
            name: newName,
            bio: newBio
        };

        if (newProfilePicBase64) {
            updateData.pic = newProfilePicBase64;
        }

        try {
            // Update Firestore
            await db.collection("users").doc(user.id).update(updateData);

            // Update local memory
            user = { ...user, ...updateData };
            localStorage.setItem('ec26_user', JSON.stringify(user));

            // Refresh UI
            updateProfileUI();
            closeEditModal();
            alert("Identity Synced.");
        } catch (e) {
            alert("Update Failed: " + e.message);
        }
    }
    async function publishPost() {
    const txt = document.getElementById('post-text').value.trim();
    if (!txt && !postImageBase64) return;
    
    try {
        await db.collection("posts").add({
            uid: user.id, // CRITICAL: This is needed for delete permissions
            name: user.name, 
            pic: user.pic, 
            role: user.role,
            txt: txt, 
            file: postImageBase64, 
            time: firebase.firestore.FieldValue.serverTimestamp(),
            likes: [],      // Initialize as empty
            comments: []    // Initialize as empty
        });
        // ... rest of reset logic
    } catch (e) { alert("Upload failed."); }
}

    
// 1. Updated File Handler for Media & Compression
async function handleFile(input) {
    const file = input.files[0];
    const statusText = document.getElementById('upload-status-text');
    if (!file) return;

    statusText.innerText = "Optimizing...";
    
    if (file.type.startsWith('video/')) {
        // Since we are limited to 1MB, we warn if video is huge
        if (file.size > 1.5 * 1024 * 1024) { 
            alert("Video too large for Hub storage. Max 1.5MB (Approx 5 secs).");
            return;
        }
        const reader = new FileReader();
        reader.onload = (e) => {
            postImageBase64 = e.target.result;
            statusText.innerText = "Video Ready üé¨";
        };
        reader.readAsDataURL(file);
    } else {
        const reader = new FileReader();
        reader.onload = (e) => {
            const img = new Image();
            img.onload = () => {
                const canvas = document.createElement('canvas');
                let width = img.width, height = img.height;
                const MAX = 700; 
                if (width > MAX) { height *= MAX / width; width = MAX; }
                canvas.width = width; canvas.height = height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, width, height);
                postImageBase64 = canvas.toDataURL('image/jpeg', 0.5); // 50% quality
                statusText.innerText = "Image Ready ‚úÖ";
            };
            img.src = e.target.result;
        };
        reader.readAsDataURL(file);
    }
}

// 2. Render Feed with AI Decoration and Social Features
function renderFeed() {
    db.collection("posts").orderBy("time", "desc").onSnapshot(snap => {
        const container = document.getElementById('feed-display');
        container.innerHTML = "";
        
        snap.forEach(doc => {
            const d = doc.data();
            const postId = doc.id;
            const likes = d.likes || [];
            const comments = d.comments || [];
            const isLiked = likes.includes(user.id);
            const isVideo = d.file && (d.file.includes("video/") || d.file.startsWith("data:video"));

            // DELETE PERMISSION: Only show trash icon if User owns post OR is Executive
            const deleteBtn = (d.uid === user.id || user.role === "Executive") ? 
                `<i data-lucide="trash-2" size="14" style="color:#ef4444; cursor:pointer; opacity:0.7;" 
                    onclick="deletePost('${postId}', '${d.uid}')"></i>` : '';

            container.innerHTML += `
                <div style="display: flex; gap: 12px; margin-bottom: 25px;">
                    <div style="display: flex; flex-direction: column; align-items: center; width: 15px; padding-top: 10px;">
                        <div class="ai-node"></div>
                        <div style="width: 1px; flex: 1; background: linear-gradient(to bottom, var(--primary-gold), transparent); opacity: 0.2;"></div>
                    </div>

                    <div class="glass-card" style="flex: 1; margin-bottom: 0;">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <img src="${d.pic}" style="width: 35px; height: 35px; border-radius: 8px; border: 1px solid var(--primary-gold); object-fit: cover;">
                                <div>
                                    <h6 style="font-size: 0.8rem;">${d.name}</h6>
                                    <small style="opacity: 0.5; font-size: 0.6rem;">${d.role}</small>
                                </div>
                            </div>
                            ${deleteBtn}
                        </div>

                        <p style="font-size: 0.85rem; margin-bottom: 10px;">${d.txt}</p>
                        
                        ${d.file ? (isVideo ? 
                            `<video src="${d.file}" controls style="width:100%; border-radius:12px; border: 1px solid var(--glass-border);" muted autoplay loop></video>` : 
                            `<img src="${d.file}" style="width:100%; border-radius:12px; border: 1px solid var(--glass-border);">`
                        ) : ''}

                        <div style="display: flex; gap: 15px; margin-top: 12px; padding-top: 10px; border-top: 1px solid var(--glass-border);">
                            <div onclick="toggleLike('${postId}', ${JSON.stringify(likes)})" style="display: flex; align-items: center; gap: 5px; cursor: pointer; color: ${isLiked ? 'var(--primary-gold)' : 'inherit'}">
                                <i data-lucide="heart" fill="${isLiked ? 'var(--primary-gold)' : 'none'}" size="16"></i>
                                <span style="font-size: 0.7rem;">${likes.length}</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 5px; opacity: 0.7;">
                                <i data-lucide="message-square" size="16"></i>
                                <span style="font-size: 0.7rem;">${comments.length}</span>
                            </div>
                        </div>

                        <div style="margin-top: 10px; padding: 10px; background: rgba(0,0,0,0.2); border-radius: 12px;">
                            <div style="max-height: 120px; overflow-y: auto; margin-bottom: 8px;">
                                ${comments.length > 0 ? comments.map((c, i) => `
                                    <div class="comment-item" 
                                         ontouchstart="startCommentHold('${postId}', ${i})" 
                                         onmousedown="startCommentHold('${postId}', ${i})"
                                         style="font-size: 0.7rem; margin-bottom: 5px; border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 4px;">
                                        <b style="color: var(--primary-gold);">${c.name}:</b> ${c.txt}
                                    </div>
                                `).join('') : '<p style="font-size: 0.6rem; opacity: 0.3; text-align: center;">No comments yet</p>'}
                            </div>

                            <div style="display: flex; gap: 5px;">
                                <input id="inp-${postId}" class="glass-input" style="margin:0; padding: 6px; font-size: 0.7rem;" placeholder="Write a comment...">
                                <button class="btn-gold" style="width: auto; padding: 0 10px;" onclick="addComment('${postId}')">
                                    <i data-lucide="send" size="12"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>`;
        });
        lucide.createIcons();
    });
}
let holdTimer;
function startCommentHold(postId, idx) {
    holdTimer = setTimeout(async () => {
        if(confirm("Delete this comment?")) {
            const snap = await db.collection("posts").doc(postId).get();
            let cms = snap.data().comments;
            if(cms[idx].uid === user.id || user.role === "Executive") {
                cms.splice(idx, 1);
                await db.collection("posts").doc(postId).update({ comments: cms });
            } else { alert("Not yours to delete!"); }
        }
    }, 800);
}
function cancelCommentHold() { clearTimeout(holdTimer); }

async function toggleLike(postId, currentLikes) {
    let newLikes = currentLikes.includes(user.id) ? 
        currentLikes.filter(id => id !== user.id) : [...currentLikes, user.id];
    await db.collection("posts").doc(postId).update({ likes: newLikes });
}

async function addComment(postId) {
    const el = document.getElementById(`inp-${postId}`);
    const txt = el.value.trim();
    if(!txt) return;

    const comment = { 
        uid: user.id, 
        name: user.name.split(' ')[0], 
        txt: txt, 
        time: Date.now() 
    };

    try {
        await db.collection("posts").doc(postId).update({
            comments: firebase.firestore.FieldValue.arrayUnion(comment)
        });
        el.value = ""; // Clear input immediately
    } catch (e) {
        console.error("Comment Error:", e);
        alert("Could not send comment.");
    }
}

// --- DELETE COMMENT LOGIC (LONG PRESS) ---

function startCommentHold(postId, commentIdx) {
    holdTimer = setTimeout(() => {
        confirmDeleteComment(postId, commentIdx);
    }, 800); // 800ms trigger
}

function cancelCommentHold() {
    clearTimeout(holdTimer);
}

async function confirmDeleteComment(postId, index) {
    if (!confirm("Delete this comment?")) return;
    
    const doc = await db.collection("posts").doc(postId).get();
    if (doc.exists) {
        let comments = doc.data().comments;
        // Verify ownership or executive status
        if (comments[index].uid === user.id || user.role === "Executive") {
            comments.splice(index, 1);
            await db.collection("posts").doc(postId).update({ comments: comments });
        } else {
            alert("Not authorized to delete this comment.");
        }
    }
}

async function deletePost(postId, postOwnerId) {
    // Only allow if it's my post OR if I am an Executive
    const canDelete = (postOwnerId === user.id) || (user.role === "Executive");
    
    if (!canDelete) {
        alert("Access Denied: You can only delete your own broadcasts.");
        return;
    }

    if (confirm("Permanently delete this broadcast?")) {
        try {
            await db.collection("posts").doc(postId).delete();
        } catch (e) {
            alert("Error deleting post.");
        }
    }
}

// Open Modal and Pre-fill data


let newProfilePicBase64 = "";



    // 1. Core Profile Data
    document.getElementById('p-card-img').src = user.pic;
    document.getElementById('p-card-name').innerText = user.name;
    
    // 2. ID Card Info with Bio Integration
    const bioText = user.bio ? user.bio : "Elite Member";
    document.getElementById('p-card-uid').innerHTML = `
        ${user.matric} <br> 
        <span style="font-size: 0.55rem; color: white; opacity: 0.5; font-family: 'Poppins'; font-style: italic;">
            "${bioText}"
        </span>`;
    
    // 3. GPA & Standing Chips
    document.getElementById('p-card-gp').innerText = user.cgpa || "0.00";
    document.getElementById('p-card-standing').innerText = user.standing || "N/A";

    // 4. Executive Role Visuals
    const roleBadge = document.getElementById('role-badge');
    const isExec = user.role === "Executive" || user.matric.startsWith('EXEC');
    
    if (isExec) {
        roleBadge.innerText = "EXECUTIVE";
        roleBadge.style.background = "var(--primary-gold)";
        roleBadge.style.color = "#011a14";
        document.getElementById('digital-id-card').style.border = "1.5px solid var(--primary-gold)";
        document.getElementById('digital-id-card').style.boxShadow = "0 0 25px rgba(212, 175, 55, 0.2)";
    } else {
        roleBadge.innerText = "MEMBER";
        roleBadge.style.background = "rgba(255,255,255,0.2)";
        roleBadge.style.color = "white";
        document.getElementById('digital-id-card').style.border = "1px solid var(--glass-border)";
    }

    lucide.createIcons();


// OPEN MODAL
function openEditModal() {
    document.getElementById('edit-profile-overlay').classList.remove('hidden');
    document.getElementById('edit-preview-img').src = user.pic;
    document.getElementById('edit-username').value = user.name;
    document.getElementById('edit-bio').value = user.bio || "";
    document.getElementById('edit-pass').value = "";
    newProfilePicBase64 = ""; // Reset temp image
}

function closeEditModal() {
    document.getElementById('edit-profile-overlay').classList.add('hidden');
}

// HANDLE NEW PHOTO PREVIEW
function handleProfilePicChange(input) {
    const file = input.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = (e) => {
            const img = new Image();
            img.onload = () => {
                const canvas = document.createElement('canvas');
                const MAX = 300; // Small size for profile pics
                let w = img.width, h = img.height;
                if (w > h) { w = MAX; h = img.height * (MAX/img.width); }
                else { h = MAX; w = img.width * (MAX/img.height); }
                canvas.width = w; canvas.height = h;
                canvas.getContext('2d').drawImage(img, 0, 0, w, h);
                newProfilePicBase64 = canvas.toDataURL('image/jpeg', 0.7);
                document.getElementById('edit-preview-img').src = newProfilePicBase64;
            };
            img.src = e.target.result;
        };
        reader.readAsDataURL(file);
    }
}

// SAVE TO FIRESTORE

    // RESTORED MARKETPLACE LOGIC
    function renderMarket() {
        const search = document.getElementById('market-search').value.toLowerCase();
        db.collection("marketplace").onSnapshot(snap => {
            const container = document.getElementById('market-display');
            container.innerHTML = "";
            let totalVal = 0;
            snap.forEach(doc => {
                const d = doc.data();
                if(d.itemName.toLowerCase().includes(search)) {
                    totalVal += d.itemPrice;
                    container.innerHTML += `
                        <div class="glass-card">
                            <h5 style="color: var(--primary-gold);">${d.itemName}</h5>
                            <p style="font-weight: 800; margin: 5px 0;">‚Ç¶${d.itemPrice.toLocaleString()}</p>
                            <button class="btn-gold" style="padding: 8px;" onclick="openChat('${d.sellerId}', '${d.sellerName}')">Contact Seller</button>
                        </div>`;
                }
            });
            document.getElementById('m-stats-val').innerText = "‚Ç¶" + totalVal.toLocaleString();
            document.getElementById('m-stats-count').innerText = snap.size;
        });
    }



    function addCourse() {
    const container = document.getElementById('course-container');
    const div = document.createElement('div');
    div.style = "display: grid; grid-template-columns: 1.2fr 1.3fr 0.5fr; gap: 8px; margin-bottom: 10px; align-items: center;";
    
    div.innerHTML = `
        <input type="text" class="c-name glass-input" placeholder="Course" style="margin:0; font-size:0.7rem; background-color: wheat;">
        <select class="c-grade glass-input" style="margin:0; font-size:0.7rem; color: black; background-color: wheat;">
            <option value="4.0">A (4.00)</option>
            <option value="3.5">AB (3.50)</option>
            <option value="3.25">B (3.25)</option>
            <option value="3.0">BC (3.00)</option>
            <option value="2.75">C (2.75)</option>
            <option value="2.5">CD (2.50)</option>
            <option value="2.25">D (2.25)</option>
            <option value="2.0">E (2.00)</option>
            <option value="0.0">F (0.00)</option>
        </select>
        <input type="number" class="c-unit glass-input" placeholder="U" style="margin:0; font-size:0.7rem;" min="1">
    `;
    container.appendChild(div);
}

async function calculateGP() {
    const grades = document.querySelectorAll('.c-grade');
    const units = document.querySelectorAll('.c-unit');
    
    let totalWeightedPoints = 0;
    let totalUnits = 0;

    units.forEach((unitInput, i) => {
        const u = parseFloat(unitInput.value);
        const g = parseFloat(grades[i].value);

        if (!isNaN(u) && u > 0) {
            totalWeightedPoints += (u * g);
            totalUnits += u;
        }
    });

    const gpa = totalUnits > 0 ? (totalWeightedPoints / totalUnits).toFixed(2) : "0.00";
    
    // Update Display
    document.getElementById('cgpa-display').innerText = gpa;
    document.getElementById('total-units').innerText = `Units: ${totalUnits}`;
    document.getElementById('gp-progress').style.width = (gpa / 4 * 100) + "%";
    
    // Class Classifications (Based on your scale)
    let standing = "Pass";
    if (gpa >= 3.50) standing = "Distinction";
    else if (gpa >= 3.00) standing = "Upper";
    else if (gpa >= 2.50) standing = "Lower";
    else if (gpa >= 2.00) standing = "Pass";
    else if (gpa > 0) standing = "Probation";
    else standing = "N/A";

    document.getElementById('gp-class').innerText = `Class: ${standing}`;

    // Cloud Sync
    if (user) {
        try {
            await db.collection("users").doc(user.id).update({ 
                cgpa: gpa,
                standing: standing 
            });
            user.cgpa = gpa;
            user.standing = standing;
            localStorage.setItem('ec26_user', JSON.stringify(user));
            alert("Academic standing successfully synced to the Hub.");
        } catch (e) {
            console.error(e);
            alert("Sync failed. Check connection.");
        }
    }
}

    function filterMembers() {
        const query = document.getElementById('member-search').value.toLowerCase();
        renderChatList(query);
    }

    function renderChatList(query = "") {
    // Listen to the users list
    db.collection("users").onSnapshot(snap => {
        const container = document.getElementById('chat-list-container');
        container.innerHTML = "";
        
        snap.forEach(doc => {
            const u = doc.data();
            if(u.id === user.id || (query && !u.name.toLowerCase().includes(query))) return;

            const chatId = [user.id, u.id].sort().join('_');
            
            // Render basic UI first
            const userDiv = document.createElement('div');
            userDiv.id = `list-item-${u.id}`;
            userDiv.className = "glass-card";
            userDiv.style = "display: flex; align-items: center; gap: 15px; padding: 15px; cursor: pointer; position: relative;";
            userDiv.onclick = () => openChat(u.id, u.name);
            
            userDiv.innerHTML = `
                <img src="${u.pic}" style="width: 48px; height: 48px; border-radius: 50%; border: 1.5px solid var(--primary-gold);">
                <div style="flex: 1;">
                    <div style="display: flex; justify-content: space-between;">
                        <h6 style="font-size: 0.85rem;">${u.name}</h6>
                        <small id="time-${chatId}" style="opacity: 0.4; font-size: 0.6rem;"></small>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 4px;">
                        <p id="preview-${chatId}" style="font-size: 0.7rem; opacity: 0.6; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 180px;">Start chatting...</p>
                        <div id="typing-${chatId}" class="hidden" style="color: var(--primary-gold); font-size: 0.6rem; font-style: italic;">typing...</div>
                    </div>
                </div>
            `;
            container.appendChild(userDiv);

            // REAL-TIME: Listen to the last message of THIS specific chat
            db.collection("chats").doc(chatId).collection("m")
              .orderBy("time", "desc").limit(1).onSnapshot(mSnap => {
                  if(!mSnap.empty) {
                      const m = mSnap.docs[0].data();
                      document.getElementById(`preview-${chatId}`).innerText = m.t;
                      if(m.time) {
                          const date = m.time.toDate();
                          document.getElementById(`time-${chatId}`).innerText = date.getHours() + ":" + date.getMinutes().toString().padStart(2, '0');
                      }
                  }
              });

            // REAL-TIME: Listen for Typing Status
            db.collection("chats").doc(chatId).onSnapshot(docSnap => {
                const data = docSnap.data();
                const typingEl = document.getElementById(`typing-${chatId}`);
                const previewEl = document.getElementById(`preview-${chatId}`);
                
                if(data && data.typing && data.typing !== user.id) {
                    typingEl.classList.remove('hidden');
                    previewEl.classList.add('hidden');
                } else {
                    typingEl.classList.add('hidden');
                    previewEl.classList.remove('hidden');
                }
            });
        });
    });
}

    async function openChat(tid, tname) {
    activeChatId = [user.id, tid].sort().join('_');
    document.getElementById('chat-header-name').innerText = tname;
    document.getElementById('chat-overlay').classList.remove('hidden');
    
    if(chatSub) chatSub();

    chatSub = db.collection("chats").doc(activeChatId).collection("m")
        .orderBy("time", "asc").onSnapshot(snap => {
            const box = document.getElementById('chat-msgs');
            box.innerHTML = "";
            
            snap.forEach(m => {
                const data = m.data();
                const isMe = data.sid === user.id;
                const timeStr = data.time ? data.time.toDate().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : "";
                
                // If it's a message sent to me, mark it as read in background
                if(!isMe && !data.read) {
                    m.ref.update({ read: true });
                }

                box.innerHTML += `
                    <div style="display: flex; flex-direction: column; align-items: ${isMe ? 'flex-end' : 'flex-start'}; gap: 2px;">
                        <div class="bubble ${isMe ? 'sent' : 'received'}">
                            ${data.t}
                        </div>
                        <div style="display: flex; align-items: center; gap: 4px; padding: 0 5px;">
                            <small style="font-size: 0.55rem; opacity: 0.4;">${timeStr}</small>
                            ${isMe ? `
                                <i data-lucide="${data.read ? 'check-check' : 'check'}" 
                                   style="width: 10px; color: ${data.read ? '#3b82f6' : 'inherit'}; opacity: 0.6;"></i>
                            ` : ''}
                        </div>
                    </div>`;
            });
            lucide.createIcons();
            box.scrollTop = box.scrollHeight;
        });
}

// Updated sendMsg to include timestamps properly
async function sendMsg() {
    const inp = document.getElementById('chat-input');
    const val = inp.value.trim();
    if(!val || !activeChatId) return;

    const msgText = val;
    inp.value = ""; 

    const now = firebase.firestore.FieldValue.serverTimestamp();

    // 1. Add message to sub-collection
    await db.collection("chats").doc(activeChatId).collection("m").add({
        sid: user.id,
        t: msgText,
        read: false,
        time: now
    });

    // 2. UPDATE PARENT: This triggers the real-time sorting in the chat list
    await db.collection("chats").doc(activeChatId).set({
        lastUpdated: now,
        lastMsg: msgText,
        typing: null
    }, { merge: true });
}


    function closeChat() { document.getElementById('chat-overlay').classList.add('hidden'); }
   
    function logout() { localStorage.clear(); location.reload(); }

    async function deletePost(postId) {
    if (!confirm("Are you sure you want to delete this broadcast?")) return;

    try {
        await db.collection("posts").doc(postId).delete();
        // Post will disappear automatically due to onSnapshot
    } catch (e) {
        console.error("Delete error:", e);
        alert("Action denied: You don't have permission to delete this.");
    }
}
let marketImageBase64 = "";

// 1. Handle Market Image Compression
function handleMarketFile(input) {
    const file = input.files[0];
    const statusText = document.getElementById('m-upload-status');
    if (file) {
        statusText.innerText = "Processing...";
        const reader = new FileReader();
        reader.onload = (e) => {
            const img = new Image();
            img.onload = () => {
                const canvas = document.createElement('canvas');
                let width = img.width, height = img.height;
                const MAX = 500; // Smaller for market
                if (width > MAX) { height *= MAX / width; width = MAX; }
                canvas.width = width; canvas.height = height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, width, height);
                marketImageBase64 = canvas.toDataURL('image/jpeg', 0.5);
                statusText.innerText = "Photo Added ‚úÖ";
            };
            img.src = e.target.result;
        };
        reader.readAsDataURL(file);
    }
}

// 2. Upload Item to Firestore
async function listMarketItem() {
    const name = document.getElementById('m-item-name').value.trim();
    const price = document.getElementById('m-item-price').value.trim();

    if (!name || !price || !marketImageBase64) return alert("Please fill all fields and add a photo.");

    try {
        await db.collection("marketplace").add({
            sellerId: user.id,
            sellerName: user.name,
            itemName: name,
            itemPrice: parseInt(price),
            itemImage: marketImageBase64,
            time: firebase.firestore.FieldValue.serverTimestamp()
        });

        // Reset
        document.getElementById('m-item-name').value = "";
        document.getElementById('m-item-price').value = "";
        marketImageBase64 = "";
        document.getElementById('m-upload-status').innerText = "Add Photo";
        alert("Item listed successfully!");
    } catch (e) { alert("Listing failed. Check storage limits."); }
}

// 3. Updated Render Market with Contact & Automated Message
function renderMarket() {
    const search = document.getElementById('market-search').value.toLowerCase();
    db.collection("marketplace").orderBy("time", "desc").onSnapshot(snap => {
        const container = document.getElementById('market-display');
        container.innerHTML = "";
        let totalVal = 0;
        
        snap.forEach(doc => {
            const d = doc.data();
            if(d.itemName.toLowerCase().includes(search)) {
                totalVal += d.itemPrice;
                container.innerHTML += `
                    <div class="glass-card" style="padding: 10px;">
                        <img src="${d.itemImage}" style="width:100%; height:150px; object-fit:cover; border-radius:15px; margin-bottom:10px;">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                            <div>
                                <h5 style="color:var(--primary-gold); font-size:0.9rem;">${d.itemName}</h5>
                                <p style="font-weight:800;">‚Ç¶${d.itemPrice.toLocaleString()}</p>
                            </div>
                            ${d.sellerId === user.id ? 
                                `<i data-lucide="trash" size="16" style="color:#ef4444;" onclick="deleteMarketItem('${doc.id}')"></i>` : ''}
                        </div>
                        <button class="btn-gold" style="padding: 10px; font-size:0.7rem;" 
                            onclick="contactSeller('${d.sellerId}', '${d.sellerName}', '${d.itemName}')">
                            Contact Seller
                        </button>
                    </div>`;
            }
        });
        document.getElementById('m-stats-val').innerText = "‚Ç¶" + totalVal.toLocaleString();
        document.getElementById('m-stats-count').innerText = snap.size;
        lucide.createIcons();
    });
}

// 4. Contact Seller + Automated Message
async function contactSeller(sid, sname, itemName) {
    if (sid === user.id) return alert("This is your item!");
    
    const chatId = [user.id, sid].sort().join('_');
    const autoMsg = `Hi ${sname.split(' ')[0]}, is the "${itemName}" still available? I'm interested!`;
    const now = firebase.firestore.FieldValue.serverTimestamp();

    await db.collection("chats").doc(chatId).collection("m").add({
        sid: user.id,
        t: autoMsg,
        read: false,
        time: now
    });

    // Update parent for sorting
    await db.collection("chats").doc(chatId).set({
        lastUpdated: now,
        lastMsg: autoMsg
    }, { merge: true });

    openChat(sid, sname);
}

async function deleteMarketItem(id) {
    if(confirm("Remove this listing?")) await db.collection("marketplace").doc(id).delete();
}

// Add these variables at the top of your script
let typingTimeout;

const chatInput = document.getElementById('chat-input');
chatInput.addEventListener('input', () => {
    if (!activeChatId) return;

    // Set typing status to My ID
    db.collection("chats").doc(activeChatId).set({
        typing: user.id
    }, { merge: true });

    // Clear status after 2 seconds of no typing
    clearTimeout(typingTimeout);
    typingTimeout = setTimeout(() => {
        db.collection("chats").doc(activeChatId).set({
            typing: null
        }, { merge: true });
    }, 2000);
});
</script>
</body>
</html>